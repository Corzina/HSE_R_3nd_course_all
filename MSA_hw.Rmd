---
title: "MSA_HW1"
output: html_document
---

Скачаем и подключим библиотеки

```{r, eval=FALSE}
library(haven)
library(plm)
library(ggplot2)
library(dplyr)
library(lmtest)
library(sandwich)
```

```{r, include=FALSE}
library(haven)
library(plm)
library(ggplot2)
library(dplyr)
library(lmtest)
library(sandwich)
```

Загрузим данные и закрепим их

```{r}
Carolina <- read_dta(file.choose())
attach(Carolina)
detach("package:dplyr")
```

**Задание 1** Оцените регрессионную модель (без учета панельной структуры данных), в которой откликом выступает логарифм числа преступлений на человека, предикторами – логарифм числа полицейских на душу населения, логарифм плотности населения, процент небелого населения

Оценим регрессионную модель. 

```{r}
lmCarolina <- lm(lncrime~lnpolice + lndensity + nonwhite, data = Carolina)
summary(lmCarolina)
```
**1.1** Проинтерпретируйте полученные результаты. В частности, сделайте вывод о характере взаимосвязи между зависимой переменной и объясняющими переменными.

Константа - значение логарифмированного уровня преступности при условии того, что ключевые предикторы = 0. Коэффициент значим.

lnpolice - значение логарифмированного числа преступлений на человека в среднем увеличивается на 0.13778 при условии того, что значение логарифмированного числа полицейских на человека растет на единицу при прочих равных. Прямой характер взаимосвязи, коэффициент значим на уровне значимости 0.001.

lndensity - значение логарифмированного числа преступлений на человека в среднем увеличивается на 0.48578 при условии того, что значение логарифмированного значения плотности населения растет на единицу при прочих равных. Прямой характер взаимосвязи, коэффициент значим на уровне значимости 0.001.

nonwhite - значение логарифмированного числа преступлений на человека в среднем увеличивается на 0.21944 при условии того, что процент небелого населения растет на единицу при прочих равных. Прямой характер взаимосвязи, коэффициент значим на уровне значимости 0.001.

Значения R-squared указывают на то, что модель объяснила 59% вариации зависимой переменной.Так как мы фиксировали пространстственную переменную.

**1.2** К чему может привести оценивание модели объединенной регрессии (pooled model) на массиве панельных данных?

Применение pooled model на массиве панельных данных может привести к:

1. Некорректной оценке значимости оценок при занижении стандартных ошибок. Это видно и у нас. 
2. aggregation bias - То, что верно для всей группы, будет казаться верным и для всех включенных суб-групп, так как мы объединили данные в один массив, хотя это не будет так (ecological fallacy). Мы говорили о том, что объединение разнородных групп в единый массив может доводить вплоть до изменения характера взаимосвязи между предикторами и откликом.

**Задание 2** Оцените модель посредством МНК с фиктивными переменными (LSDV-модель с набором дамми-переменных на константы). Сравните полученные результаты с результатами модели, построенной без учета панельной структуры данных. Проинтерпретируйте оценки коэффициентов при трех любых статистически-значимых дамми-переменных.

Оценим соответствующую модель, в качестве базового округа выберем 1. Потенциально, содержательнее включить в модель переменную, отвечающую за год, чем за "район" Каролины - районов очень много, учитывая их количество будет сложно получить значимые оценки. Но задание не указывает, какие эффекты нам нужно включить - временные или пространственные, поэтому включим последние. 

```{r}
fcounty <- relevel(factor(county), ref ="1")
LSDV_county <- lm(lncrime~lnpolice + lndensity + nonwhite + fcounty)
summary(LSDV_county)
```
**2.1** Направление взаимосвязи осталось как в предыдущей pooled модели для предикторов lnpolice и nonwhite, при этом для второго снизилась значимость. Предиктор lndensity перестал быть значимым и изменил характер взаимосвязи с откликом. Ранее обсуждалось, что давать интерпретацию незначимым предикторам в целом не имеет смысла. Выросло значение константы, которая теперь отражает 1 округ, что также логично - полученные дамми-переменные отражают некоторый фиксированный эффект, не влияя на характер взаимосвязи переменных, но показывая разницу стартовых условий.

**2.2** на 0.725701 в среднем отклоняется в большую сторону значение логарифмированного числа преступлений на человека в 11-м округе при переходе от 1-округа при прочих равных предикторах.

на 0.561621 в среднем отклоняется в большую сторону значение логарифмированного числа преступлений на человека в 21-м округе при переходе от от 1-округа при прочих равных предикторах.

на 1.148504 в среднем отклоняется в меньшую сторону значение логарифмированного числа преступлений на человека в 137-м округе при переходе от от 1-округа при прочих равных предикторах. Интерпретировать с осторожностью, этот коэффициент значим только при высоком (0.01) значении уровней значимости.

**Задание 3**  Оцените модель, используя внутригрупповое преобразование (withingroup transformation).

Оценим:

```{r}
fe <- plm(lncrime~lnpolice + lndensity + nonwhite, data = Carolina, index=c("county", "year"), model="within")
summary(fe)
```

**3.1** Проинтерпретируйте полученные результаты. Сравните коэффициенты при предикторах с коэффициентами при соответствующих предикторах в модели с набором дамми-переменных на константы.

Данные снизу интерпретации сравнимы с интерпретацией LSDV модели. Можно добавить, что так как мы фиксируем пространственные эффекты, не лишним указывать об изменениях "в пространственной перспективе".

lnpolice - значение логарифмированного числа преступлений на человека в среднем увеличивается на 0.213866 при условии того, что значение логарифмированного числа полицейских на человека растет на единицу при прочих равных. Прямой характер взаимосвязи, коэффициент значим на уровне значимости 0.001.

lndensity - значение логарифмированного числа преступлений на человека в среднем уменьшается на 0.055860 при условии того, что значение логарифмированного значения плотности населения растет на единицу при прочих равных. Коэффициент незначим.

**3.2** Коэффициент при каком предикторе не позволяет оценить модель с внутригрупповым преобразованием? Объясните, почему.

```{r}
Carolina %>%
group_by(county) %>%
summarize(var = var(nonwhite))
```

Коэффициент nonwhite имеет нулевые вариации внутри групп, он является константой для каждого округа. Поэтому он не позволяет оценить модель с внутригрупповым преобразованием. 

**Задание 4** Проверьте гипотезу о том, что все индивидуальные эффекты равны нулю. Сделайте вывод о том, какая модель более адекватна данным:модель с фиксированными эффектами или модель без учета панельной структуры.

Проверим. Для этого нам понадобится F-тест (в ней такая нулевая гипотеза) и pooled model. pooled model Мы будем сравнивать с fixed-effects model. В целом, это та же модель, что была в 1-м задании. 

```{r}
ols <- plm(lncrime~lnpolice + lndensity + nonwhite, data = Carolina, model="pooling")
summary(ols)
pFtest(fe, ols) 
```
Значения P-value очень малы, значит нулевая гипотеза о незначимости фикс. эффектов отвергается в пользу альтернативы (есть значимые фикс. эффекты). Соответственно, предпочитаем Fixed Effects Model.

**Задание 5** Оцените модель со случайными эффектами.

Оценим:

```{r}
re <- plm(lncrime~lnpolice + lndensity + nonwhite, data=Carolina, index=c("county", "year"), model="random") 
summary(re)
```

**5.1** Проверьте гипотезу о том, что дисперсия случайного индивидуального эффекта равна 0. В пользу какой модели Вы сделаете выбор:модели со случайными эффектами или модели без учета панельной структуры данных?

Проверим с помощью БП теста:

```{r}
plmtest(ols, type=c("bp"))
```
Значения P-value очень малы, значит нулевая гипотеза о равенстве Var случайного индивидуального эффекта нулю отвергается в пользу альтернативы (она не равна нулю). Соответственно, предпочитаем Random Effects Model, а не pooled model.

**5.2** Сравните результаты с результатами модели с фиксированными эффектами. Какое допущение главным образом отличает RE-model от FE-model? Поразмышляйте, правдоподобно ли это допущение применительно к нашим данным (поясните, почему, проиллюстрируйте конкретным примером)?

Ключевое допущение RE-модели: $Cov(\alpha_{i};x_{it})=0$, Ковариация случайных эффектов и ключевых предикторов отсутствует. Применительно к нашей модели, это допущение неправдоподобно, так как объясняющие переменные отражают пространственную неоднородность, но они же вносятся в RE-модели в случайный эффект, который отражает набор неизменяющихся во времени характеристик пространственных единиц. Случайный эффект также содержит в себе пространственную неоднородность, и отсюда возникает несоблюдение этого допущения. Поэтому в результате значимость отдельных предикторов будет падать, а сама модель будет объяснять меньшую долю вариации. 


**5.3** Протестируйте посредством теста Хаусмана отсутствие корреляции между индивидуальными эффектами и предикторами. Сделайте вывод. Назовите ограничения теста Хаусмана.

Протестируем:

```{r}
phtest(fe, re) 
```
Значение p-value приграничное, но я думаю что нам стоит отвергнуть гипотезу в пользу альтернативы на уровне значимости 0.05, и как итог предпочесть Fixed Effects model вместо Random Effects model.

Но надо помнить про ограничения этого теста:
1. У теста Хаусмана малая мощность, он может не распознать корреляцию.
2. Нам необходимо пробовать содержательно оценить массив, чтобы у нас заранее была уверенность в возможности экстраполяции результатов модели. Позволяют ли данные использовать ту модель, которую тест показывает как оптимальную? Он может быть не особо нужен нам, если мы разбираемся в специфике данных.

**Задание 6** Протестируйте альтернативные спецификации модели: с включением временных эффектов и twoway model (с включением и пространственных, и временных эффектов). Объясните различия в интерпретации оценок коэффициентов при предикторах в разных моделях. Какая модель более адекватна в данном случае? Выбранную модель переоцените с поправкой на гетероскедастичность.

Протестируем с включением временных эффектов:

```{r}
fyear <- relevel(factor(year), ref ="81")
LSDV_year <- lm(lncrime~lnpolice + lndensity + nonwhite + fyear)
summary(LSDV_year) 
```
Разница в интерпретации - так как мы фиксируем временные, а не пространственные эффекты, интерпретация ключевых предикторов будет включать в себя определение "в пространственной перспективе". В остальном интерпретация сохраняется как в модели с фиксированными пространственными эффектами, данной выше. 

По моему мнению, интересные исследовательские вопросы можно поставить для обеих моделей: Как пример, нас может интересовать, действительно ли в зависимости от года значимо менялись значения уровня преступности? Модель позволяет задать вопрос - почему в одни годы уровень преступности снижался значимо, а в другие - нет? В равной степени, нас могут интересовать наиболее отклоняющиеся округа, Для которых нужна предыдущая модель (действительно ли существуют значимые различия в стартовых условиях по округам в Северной Каролине итд.). В общем виде, это зависит от нашего исследовательского воображения.


Протестируем two-way model:

```{r}
fe_twoways <- plm(lncrime~lnpolice + lndensity + nonwhite, data=Carolina, index=c("county", "year"), effect = "twoways", model = "within")
summary(fe_twoways)
```

Теперь коэффициенты при предикторе показывают, насколько в среднем при их увеличении на 1 изменяется значение логарифмированного показателя преступности как в пространственной(межокружной), так и временной перспективе при прочих равных.

Оценим, какая модель лучше:
```{r}
pFtest(fe_twoways, fe)
```
Значения P-value очень малы, значит нулевая гипотеза о незначимости фикс. эффектов отвергается в пользу альтернативы (есть значимые фикс. эффекты). Соответственно, предпочитаем Two-way Model.

переоценим её с поправкой на гетероскедастичность:

```{r}
bptest(fe_twoways) 
coeftest(fe_twoways, vcov = vcovHC, type = "HC3")
```

Значимость предикторов упала, и теперь количество и направление предикторов модели напоминает Fe-within

**Задание 7** Протестируйте, устойчива ли выбранная модель. Переоцените модель на усеченной выборке: без округов, в которых корреляция предсказанного отклика и наблюдаемого мала. Изменились ли значительно результаты?

Протестируем:

```{r}

LSDV_twoways <- lm(lncrime~lnpolice + lndensity + nonwhite + as.factor(county) + as.factor(year), data = Carolina) 
y_pred <- LSDV_twoways$fitted 
Carolina1 <- data.frame(Carolina, y_pred)
```

```{r}
merged <- Carolina1 %>% group_by(county)%>% summarize(., cor(lncrime, y_pred))%>% merge(Carolina1, ., by="county")
head(merged)
```

```{r}
merged$new <- ifelse(abs(merged$`cor(lncrime, y_pred)`)<0.3,1,0)
fe_twoways_2 <- plm(lncrime~lnpolice + lndensity + nonwhite, merged[merged$new == 0,], index=c("county", "year"), effect = "twoways")
coeftest(fe_twoways_2, vcov = vcovHC, type = "HC3")
```

Модель действительно сравнительно устойчива, но не при высоких уровнях значимости. Помимо этого, результаты у нас значимо изменились - теперь предиктор lndensity стал значимым, а оцененное значение коэффициента при нем выросло.

**Вывод** Для этих данных наиболее адекватна модель twoway, хотя в рамках этой модели мы также получаем очень низкие значения $R^{2}$. После усечения выборки результаты сместились, так как мы выбросили те наблюдения, которые ранее делали коэффициент при lndensity незначимым - поэтому результаты и изменились. Этот коэффициент и коэффициент при lnpolice в итоге значимы. Так как приведена модель twoway, фиксирующая и пространственные, и временные эффекты, мы в какой-то степени имеем право интерпретировать результаты в терминах каузальности. Дальше лучше всего было бы расшририть датасет, потому что на данный момент предсказательная сила лучшей модели очень низка. Учитывая ограничения наших данных - например, для каждого округа есть только 7 наблюдений, сложно получить еще более репрезентативные оценки значимых отличий в стартовых условиях непосредственно в этом округе. 

**Бонус 8.1** Оцените регрессионную модель с фиксированными эффектами на константу, в которой откликом является по-прежнему логарифм числа преступлений на человека, а предиктор только один – логарифм плотности населения. Покажите, как получить оценку коэффициента при данном предикторе на основе оценок коэффициентов регрессионных моделей, оцененных на отдельных подгруппах (округа формируют подгруппы). В каком случае подгруппа (в данном случае – округ) не учитывается (то есть, не имеет веса) при расчете оценки коэффициента модели с фиксированными эффектами?

Оценим:

```{r}
fcounty <- relevel(factor(county), ref ="1")
fe_constant <- lm(lncrime~lndensity + fcounty, data = Carolina)
summary(fe_constant)
```

Получим оценку коэффициента при данном предикторе на основе оценок коэффициентов регрессионных моделей, оцененных на отдельных подгруппах

```{r}
#Step 1. Group (country) variances of X (state_capacity)
var <- summarize(group_by(Carolina, county), var(lndensity)) 
var

#Step 2. Run separate regressions (for each country) 
a <- group_by(Carolina, county) %>%
  do(data.frame(beta = coef(lm(lncrime~lndensity, data = .))[2])) 
a

#Step 3. Weighted sum of coefficients from separate regression models. 
# Use conditional variances as weights
m <- as.data.frame(merge(a, var, by ="county"))
m
m$coef <- m$beta*(m$`var(lndensity)`/sum(m$`var(lndensity)`))
sum(m$coef)
```
Округ не имеет веса при расчете оценки коэффициента модели с фиксированными эффектами, если его вариация равна нулю - это связано с тем, что эта вариация и является весом округа в итоговой оценке. 


